<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.60">
    <script>
      (function() {
        const userMode = localStorage.getItem('vuepress-reco-color-scheme') || 'auto';
        const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

        if (userMode === 'dark' || (userMode === 'auto' && systemDarkMode)) {
          document.documentElement.classList.toggle('dark', true);
        }
      })();
    </script>
    <link rel="icon" href="/favicon.ico"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><title>一条查询SQL语句是如何执行的？ |  cheng's note</title><meta name="description" content="个人笔记.">
    <link rel="modulepreload" href="/assets/app-9816ed7f.js"><link rel="modulepreload" href="/assets/framework-e1bed10d.js"><link rel="modulepreload" href="/assets/how_select.html-6d7d8cb4.js"><link rel="modulepreload" href="/assets/how_select.html-944df99e.js"><link rel="prefetch" href="/assets/index.html-ef2f4f01.js" as="script"><link rel="prefetch" href="/assets/index.html-2cdae655.js" as="script"><link rel="prefetch" href="/assets/index.html-a423a7f3.js" as="script"><link rel="prefetch" href="/assets/index.html-5c0907dc.js" as="script"><link rel="prefetch" href="/assets/index.html-e12f154a.js" as="script"><link rel="prefetch" href="/assets/index.html-59a081ca.js" as="script"><link rel="prefetch" href="/assets/salary_calculator.html-389ae649.js" as="script"><link rel="prefetch" href="/assets/mysql_index.html-cbacfa43.js" as="script"><link rel="prefetch" href="/assets/mysql_lock.html-c392f6b5.js" as="script"><link rel="prefetch" href="/assets/404.html-f9875e7b.js" as="script"><link rel="prefetch" href="/assets/index.html-bdec80a5.js" as="script"><link rel="prefetch" href="/assets/index.html-47e4ee8b.js" as="script"><link rel="prefetch" href="/assets/index.html-ef51ba1b.js" as="script"><link rel="prefetch" href="/assets/index.html-3c78780e.js" as="script"><link rel="prefetch" href="/assets/index.html-48e1c605.js" as="script"><link rel="prefetch" href="/assets/index.html-40bced6f.js" as="script"><link rel="prefetch" href="/assets/salary_calculator.html-601ea710.js" as="script"><link rel="prefetch" href="/assets/mysql_index.html-f85ccfe4.js" as="script"><link rel="prefetch" href="/assets/mysql_lock.html-2680ceae.js" as="script"><link rel="prefetch" href="/assets/404.html-7c90b0cc.js" as="script"><link rel="prefetch" href="/assets/reco-valine-a0c1af1f.js" as="script">
    <link rel="preload" href="/assets/style-80b549e1.css" as="style"><link rel="stylesheet" href="/assets/style-80b549e1.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><div class="common-wrapper series--no"><div><header class="navbar-container"><!--[--><div class="site-brand nav-item"><img class="logo" src="/logo.png" alt=" cheng&#39;s note"><a href="/" class="site-name can-hide"> cheng&#39;s note</a></div><div class="nav-item navbar-links-wrapper" style=""><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form><nav class="navbar-links"><!--[--><div class="navbar-links__item"><a href="/" class="link" aria-label="主页"><!--[--><!--]--><!--v-if--><span>主页</span><!--[--><!--]--></a></div><div class="navbar-links__item"><div class="dropdown-link"><button class="dropdown-link__title" type="button" aria-label="分类"><span class="title"><!----><span>分类</span></span><span class="arrow down"></span></button><button class="dropdown-link--mobile__title" type="button" aria-label="分类"><span class="title"><!----><span>分类</span></span><span class="right arrow"></span></button><ul style="display:none;" class="dropdown-link__container"><!--[--><li class="dropdown-link__item"><a href="/categories/MySQL/1/" class="link" aria-label="MySQL"><!--[--><!--]--><!--v-if--><span>MySQL</span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/categories/sheji/1/" class="link" aria-label="设计"><!--[--><!--]--><!--v-if--><span>设计</span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links__item"><div class="dropdown-link"><button class="dropdown-link__title" type="button" aria-label="标签"><span class="title"><!----><span>标签</span></span><span class="arrow down"></span></button><button class="dropdown-link--mobile__title" type="button" aria-label="标签"><span class="title"><!----><span>标签</span></span><span class="right arrow"></span></button><ul style="display:none;" class="dropdown-link__container"><!--[--><li class="dropdown-link__item"><a href="/tags/QLExpress/1/" class="link" aria-label="QLExpress"><!--[--><!--]--><!--v-if--><span>QLExpress</span><!--[--><!--]--></a></li><!--]--></ul></div></div><!--]--></nav><a class="xicon-container btn-toggle-dark-mode btn--dark-mode"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" style="width:20px;height:20px;font-size:20px;color:inherit;"><path d="M15 2h2v3h-2z" fill="currentColor"></path><path d="M27 15h3v2h-3z" fill="currentColor"></path><path d="M15 27h2v3h-2z" fill="currentColor"></path><path d="M2 15h3v2H2z" fill="currentColor"></path><path d="M5.45 6.884l1.414-1.415l2.121 2.122l-1.414 1.414z" fill="currentColor"></path><path d="M23 7.58l2.121-2.12l1.414 1.414l-2.121 2.121z" fill="currentColor"></path><path d="M23.002 24.416l1.415-1.414l2.12 2.122l-1.413 1.414z" fill="currentColor"></path><path d="M5.47 25.13L7.59 23L9 24.42l-2.12 2.12l-1.41-1.41z" fill="currentColor"></path><path d="M16 8a8 8 0 1 0 8 8a8 8 0 0 0-8-8zm0 14a6 6 0 0 1 0-12z" fill="currentColor"></path></svg></a><a class="xicon-container btn-toggle-menus"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" style="width:20px;height:20px;font-size:20px;color:inherit;"><circle cx="16" cy="8" r="2" fill="currentColor"></circle><circle cx="16" cy="16" r="2" fill="currentColor"></circle><circle cx="16" cy="24" r="2" fill="currentColor"></circle></svg></a></div><!--]--></header><div class="mobile-menus-container"><nav class="navbar-links mobile"><!--[--><div class="navbar-links__item"><a href="/" class="link" aria-label="主页"><!--[--><!--]--><!--v-if--><span>主页</span><!--[--><!--]--></a></div><div class="navbar-links__item"><div class="dropdown-link"><button class="dropdown-link__title" type="button" aria-label="分类"><span class="title"><!----><span>分类</span></span><span class="arrow down"></span></button><button class="dropdown-link--mobile__title" type="button" aria-label="分类"><span class="title"><!----><span>分类</span></span><span class="right arrow"></span></button><ul style="display:none;" class="dropdown-link__container"><!--[--><li class="dropdown-link__item"><a href="/categories/MySQL/1/" class="link" aria-label="MySQL"><!--[--><!--]--><!--v-if--><span>MySQL</span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/categories/sheji/1/" class="link" aria-label="设计"><!--[--><!--]--><!--v-if--><span>设计</span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links__item"><div class="dropdown-link"><button class="dropdown-link__title" type="button" aria-label="标签"><span class="title"><!----><span>标签</span></span><span class="arrow down"></span></button><button class="dropdown-link--mobile__title" type="button" aria-label="标签"><span class="title"><!----><span>标签</span></span><span class="right arrow"></span></button><ul style="display:none;" class="dropdown-link__container"><!--[--><li class="dropdown-link__item"><a href="/tags/QLExpress/1/" class="link" aria-label="QLExpress"><!--[--><!--]--><!--v-if--><span>QLExpress</span><!--[--><!--]--></a></li><!--]--></ul></div></div><!--]--></nav><div class="appearance"><span>Appearance</span><a class="xicon-container btn-toggle-dark-mode"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" style="width:20px;height:20px;font-size:20px;color:inherit;"><path d="M15 2h2v3h-2z" fill="currentColor"></path><path d="M27 15h3v2h-3z" fill="currentColor"></path><path d="M15 27h2v3h-2z" fill="currentColor"></path><path d="M2 15h3v2H2z" fill="currentColor"></path><path d="M5.45 6.884l1.414-1.415l2.121 2.122l-1.414 1.414z" fill="currentColor"></path><path d="M23 7.58l2.121-2.12l1.414 1.414l-2.121 2.121z" fill="currentColor"></path><path d="M23.002 24.416l1.415-1.414l2.12 2.122l-1.413 1.414z" fill="currentColor"></path><path d="M5.47 25.13L7.59 23L9 24.42l-2.12 2.12l-1.41-1.41z" fill="currentColor"></path><path d="M16 8a8 8 0 1 0 8 8a8 8 0 0 0-8-8zm0 14a6 6 0 0 1 0-12z" fill="currentColor"></path></svg></a></div></div><div class="series-mask"></div><aside class="series-container"><div class="site-brand"><img class="logo" src="/logo.png" alt=" cheng&#39;s note"><a href="/" class="site-name can-hide"> cheng&#39;s note</a></div><!--[--><!--]--></aside><!--[--><main class="page-container show-catalog"><h1 class="page-title">一条查询SQL语句是如何执行的？</h1><div class="page-info"><a class="xicon-container left" href="javascript:void(0)" target="_self"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:inherit;"><path d="M16 4a5 5 0 1 1-5 5a5 5 0 0 1 5-5m0-2a7 7 0 1 0 7 7a7 7 0 0 0-7-7z" fill="currentColor"></path><path d="M26 30h-2v-5a5 5 0 0 0-5-5h-6a5 5 0 0 0-5 5v5H6v-5a7 7 0 0 1 7-7h6a7 7 0 0 1 7 7z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->cheng<!--]--></span></a><a class="xicon-container left" href="javascript:void(0)" target="_self"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:inherit;"><path d="M26 4h-4V2h-2v2h-8V2h-2v2H6c-1.1 0-2 .9-2 2v20c0 1.1.9 2 2 2h20c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 22H6V12h20v14zm0-16H6V6h4v2h2V6h8v2h2V6h4v4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->2023/01/10<!--]--></span></a><a class="xicon-container left" href="javascript:void(0)" target="_self"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:inherit;"><path d="M11.17 6l3.42 3.41l.58.59H28v16H4V6h7.17m0-2H4a2 2 0 0 0-2 2v20a2 2 0 0 0 2 2h24a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2H16l-3.41-3.41A2 2 0 0 0 11.17 4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->MySQL<!--]--></span></a><!----><a class="xicon-container left" href="javascript:void(0)" target="_self"><!--[--><svg class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:inherit;" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 12 12"><g fill="none"><path d="M1.974 6.659a.5.5 0 0 1-.948-.317c-.01.03 0-.001 0-.001a1.633 1.633 0 0 1 .062-.162c.04-.095.099-.226.18-.381c.165-.31.422-.723.801-1.136C2.834 3.827 4.087 3 6 3c1.913 0 3.166.827 3.931 1.662a5.479 5.479 0 0 1 .98 1.517l.046.113c.003.008.013.06.023.11L11 6.5s.084.333-.342.474a.5.5 0 0 1-.632-.314v-.003l-.006-.016a3.678 3.678 0 0 0-.172-.376a4.477 4.477 0 0 0-.654-.927C8.584 4.673 7.587 4 6 4s-2.584.673-3.194 1.338a4.477 4.477 0 0 0-.795 1.225a2.209 2.209 0 0 0-.03.078l-.007.018zM6 5a2 2 0 1 0 0 4a2 2 0 0 0 0-4zM5 7a1 1 0 1 1 2 0a1 1 0 0 1-2 0z" fill="currentColor"></path></g></svg><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[--><span id="/blogs/mysql/how_select.html" class="leancloud-visitors" data-flag-title="Your Article Title"><a class="leancloud-visitors-count" style=""></a></span><!--]--></span></a></div><div class="theme-reco-default-content"><div><h2 id="mysql的逻辑架构" tabindex="-1"><a class="header-anchor" href="#mysql的逻辑架构" aria-hidden="true">#</a> MySQL的逻辑架构</h2><p><img src="/assets/MYSQL架构图-0531f3c6.png" alt="MYSQL架构图"></p><p>大体来说，MySQL的架构有Server层和存储层两部分组成。</p><ul><li><p><code>Server层负责建立连接、分析、优化和执行SQL</code> MySQL的大部分核心功能以及内置函数、存储过程、触发器、视图等功能都在是Server层实现的。</p></li><li><p><code>存储引擎层负责数据的存储和提取。</code>其架构模式是插件式的，支持InnoDB、MyISAM、 Memory等多个存储引擎。现在最常用的存储引擎是InnoDB，它从MySQL 5.5.5版本开始成为了默认的存储引擎。</p></li></ul><p>你可以先对每个组件的名字有个印象，接下来我们结合开头提到的那条SQL语句，走一遍整个执行流程，依次看下每个组件的作用。</p><h2 id="第一步-连接器" tabindex="-1"><a class="header-anchor" href="#第一步-连接器" aria-hidden="true">#</a> 第一步 连接器</h2><p>连接的命令如下：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>mysql -h<span class="token variable">$ip</span> -u<span class="token variable">$user</span> <span class="token parameter variable">-p</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>如果用户密码都没有问题，连接器就会获取该用户的权限，然后保存起来，后续该用户在此连接里的任何操作，都会基于连接开始时读到的权限进行权限逻辑的判断。</p><p>所以，如果一个用户已经建立了连接，即使管理员中途修改了该用户的权限，也不会影响已经存在连接的权限。修改完成后，只有再新建的连接才会使用新的权限设置。</p><div class="custom-container tip"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="9"></circle><path d="M12 8h.01"></path><path d="M11 12h1v4h1"></path></g></svg><p class="custom-container-title">TIP</p><p>如何查看 MySQL服务被多少个客户端连接了？</p></div><p>通过以下命令可以查看当前MySQL服务的连接数以及连接状态。</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">show</span> processlist<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>mysql<span class="token operator">&gt;</span> show processlist<span class="token punctuation">;</span>
+-----+------+-----------+------+---------+------+----------+------------------+
<span class="token operator">|</span> Id  <span class="token operator">|</span> User <span class="token operator">|</span> Host      <span class="token operator">|</span> db   <span class="token operator">|</span> Command <span class="token operator">|</span> Time <span class="token operator">|</span> State    <span class="token operator">|</span> Info             <span class="token operator">|</span>
+-----+------+-----------+------+---------+------+----------+------------------+
<span class="token operator">|</span> <span class="token number">158</span> <span class="token operator">|</span> root <span class="token operator">|</span> localhost <span class="token operator">|</span> NULL <span class="token operator">|</span> Query   <span class="token operator">|</span>    <span class="token number">0</span> <span class="token operator">|</span> starting <span class="token operator">|</span> show processlist <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">174</span> <span class="token operator">|</span> root <span class="token operator">|</span> localhost <span class="token operator">|</span> NULL <span class="token operator">|</span> Sleep   <span class="token operator">|</span>  <span class="token number">865</span> <span class="token operator">|</span>          <span class="token operator">|</span> NULL             <span class="token operator">|</span>
+-----+------+-----------+------+---------+------+----------+------------------+
<span class="token number">2</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如上图所示，其中 Command 列显示为 Sleep 的这一行就表示连接是一个空闲连接，Time表示空间时间。</p><div class="custom-container tip"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="9"></circle><path d="M12 8h.01"></path><path d="M11 12h1v4h1"></path></g></svg><p class="custom-container-title">TIP</p><p>空闲连接会一直占用吗？</p></div><p>客户端如果太长时间没有和MySQL服务器发生交互，连接器就会自动将它断开。这个时间是由参数wait_timeout控制的，默认值是8小时。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>mysql<span class="token operator">&gt;</span> show variables like <span class="token string">&#39;wait_timeout&#39;</span><span class="token punctuation">;</span>
+---------------+-------+
<span class="token operator">|</span> Variable_name <span class="token operator">|</span> Value <span class="token operator">|</span>
+---------------+-------+
<span class="token operator">|</span> wait_timeout  <span class="token operator">|</span> <span class="token number">28800</span> <span class="token operator">|</span>
+---------------+-------+
<span class="token number">1</span> row <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.02</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们自己也可以手动断开空闲的连接，使用的是 kill connection + id 的命令。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>mysql<span class="token operator">&gt;</span> <span class="token function">kill</span> connection +174<span class="token punctuation">;</span>
Query OK, <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container warning"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="9"></circle><path d="M12 8v4"></path><path d="M12 16h.01"></path></g></svg><p class="custom-container-title">WARNING</p><p>MySQL 的连接数有限制吗？</p></div><p>MySQL服务支持的最大连接数由max_connections参数控制。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>mysql<span class="token operator">&gt;</span> show variables like <span class="token string">&#39;max_connections&#39;</span><span class="token punctuation">;</span>
+-----------------+-------+
<span class="token operator">|</span> Variable_name   <span class="token operator">|</span> Value <span class="token operator">|</span>
+-----------------+-------+
<span class="token operator">|</span> max_connections <span class="token operator">|</span> <span class="token number">151</span>   <span class="token operator">|</span>
+-----------------+-------+
<span class="token number">1</span> row <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>建立连接的过程通常是比较复杂的，所以建议在使用中要尽量减少建立连接的动作，也就是尽量使用长连接，比如后端开发中经常使用的数据库连接池。</p><p>但是全部使用长连接后，你可能会发现，有些时候MySQL占用内存涨得特别快，这是因为MySQL在执行过程中临时使用的内存是管理在连接对象里面的。 这些资源会在连接断开的时候才释放。所以如果长连接累积下来，可能导致内存占用太大，被系统强行杀掉（OOM），从现 象看就是MySQL异常重启了。</p><p>怎么解决这个问题呢？你可以考虑以下两种方案。</p><ul><li><code>定期断开长连接。</code>使用一段时间，或者程序里面判断执行过一个占用内存大的查询后，断开连接，之后要查询再重连。</li><li><code>客户端主动重置连接。</code> MySQL 5.7 版本实现了 mysql_reset_connection() 函数的接口，注意这是接口函数不是命令，那么当客户端执行了一个很大的操作后，在代码里调用 mysql_reset_connection 函数来重置连接，达到释放内存的效果。这个过程不需要重连和重新做权限验证，但是会将连接恢复到刚刚创建完时的状态。</li></ul><h2 id="第二步-查询缓存" tabindex="-1"><a class="header-anchor" href="#第二步-查询缓存" aria-hidden="true">#</a> 第二步 查询缓存</h2><p>连接建立完成后，就可以往MySQL服务器发送SQL语句了。MySQL会先解析出SQL的类型，如果是查询类型的SQL，会先到查询缓存看看，之前是不是执行过这个SQL。 这个缓存的key是SQL语句，values是查询的结果。如果你的查询能够在缓存中命中，MySQL就会直接把这个value返回客户端。 如果查询语句没有命中缓存，就会继续后面的执行阶段。执行完成后，执行结果就放入到查询缓存中。</p><p>但是大多数的情况下，还是不建议使用查询缓存，为什么呢？因为查询缓存往往弊大于利。 对于一个表的任何更新操作，都会导致查询缓存的失效，对于一个线上的业务表更新是在所难免的，查询缓存的命中率非常低。 除非你的某个业务表数据是静态的，发生更新的频率非常低。比如一个系统配置表，这时候查询缓存才能发挥它的作用。 MySQL也提供了按需使用的方式，通过将query_cache_type设置成DEMAND来禁用自动使用查询缓存。 然后在你认为合适的表上，使用<code>SQL_CACHE</code> 关键字让MySQL使用查询缓存。</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">select</span> SQL_CACHE <span class="token operator">*</span> <span class="token keyword">from</span> t_user <span class="token keyword">where</span> user_id<span class="token operator">=</span><span class="token number">100</span>；
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>不过实际开发中一般很少这么用，对于缓存命中率比较高的静态表，使用redis或者本地缓存更合适。 而且MySQL在8.0版本已经将查询缓存的功能移除了！</p><h2 id="第三步-分析器" tabindex="-1"><a class="header-anchor" href="#第三步-分析器" aria-hidden="true">#</a> 第三步 分析器</h2><p>如果没有命中查询缓存，就要真正开始执行SQL了。首先，MySQL需要知道你要做什么，因此需要先对SQL语句进行解析。</p><p>主要涉及到词法分析和语法分析。 如果我们输入的 <code>SQL</code>语句语法不对，就会在解析器这个阶段报错。比如，下面这条查询语句，把 from 写成了 form，这时 MySQL 解析器就会报错。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> * from t_user<span class="token punctuation">;</span>
Empty <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> * form t_user<span class="token punctuation">;</span>
ERROR <span class="token number">1064</span> <span class="token punctuation">(</span><span class="token number">42000</span><span class="token punctuation">)</span>: You have an error <span class="token keyword">in</span> your SQL syntax<span class="token punctuation">;</span> check the manual that corresponds to your MySQL server version <span class="token keyword">for</span> the right syntax to use near <span class="token string">&#39;form t_user&#39;</span> at line <span class="token number">1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="第四步-优化器" tabindex="-1"><a class="header-anchor" href="#第四步-优化器" aria-hidden="true">#</a> 第四步 优化器</h2><p><code>优化器主要负责将SQL的执行方案确定下来</code>，比如在表里面有多个索引的时候，决定使用哪个索引；或者在一个语句有多表关联（join） 的时候，决定各个表的连接顺序。</p><p>比如我们有如下表结构:</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>t_user<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>age<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>index_name<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>索引结构如下：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>mysql<span class="token operator">&gt;</span> show index from t_user<span class="token punctuation">;</span>                                                                       +--------+------------+------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
<span class="token operator">|</span> Table  <span class="token operator">|</span> Non_unique <span class="token operator">|</span> Key_name   <span class="token operator">|</span> Seq_in_index <span class="token operator">|</span> Column_name <span class="token operator">|</span> Collation <span class="token operator">|</span> Cardinality <span class="token operator">|</span> Sub_part <span class="token operator">|</span> Packed <span class="token operator">|</span> Null <span class="token operator">|</span> Index_type <span class="token operator">|</span> Comment <span class="token operator">|</span> Index_comment <span class="token operator">|</span>
+--------+------------+------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
<span class="token operator">|</span> t_user <span class="token operator">|</span>          <span class="token number">0</span> <span class="token operator">|</span> PRIMARY    <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span> user_id     <span class="token operator">|</span> A         <span class="token operator">|</span>        <span class="token number">1000</span> <span class="token operator">|</span>     NULL <span class="token operator">|</span> NULL   <span class="token operator">|</span>      <span class="token operator">|</span> BTREE      <span class="token operator">|</span>         <span class="token operator">|</span>               <span class="token operator">|</span>
<span class="token operator">|</span> t_user <span class="token operator">|</span>          <span class="token number">1</span> <span class="token operator">|</span> index_name <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span> name        <span class="token operator">|</span> A         <span class="token operator">|</span>        <span class="token number">1000</span> <span class="token operator">|</span>     NULL <span class="token operator">|</span> NULL   <span class="token operator">|</span>      <span class="token operator">|</span> BTREE      <span class="token operator">|</span>         <span class="token operator">|</span>               <span class="token operator">|</span>
+--------+------------+------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
<span class="token number">2</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>t_user表就有主键索引（user_id）和普通索引（name）假设执行了这条查询语句:</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">select</span> user_id<span class="token punctuation">,</span>name <span class="token keyword">from</span> t_user <span class="token keyword">where</span> user_id <span class="token operator">&gt;</span> <span class="token number">10</span>  <span class="token operator">and</span> name <span class="token operator">like</span> <span class="token string">&#39;用户1%&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>这条查询语句既可以使用主键索引也可以使用普通索引(name)，查询结果都是一样的，但执行的效率完全不相同。这时就需要优化器来决定使用哪个索引了。</p><p>我们可以使用<code>explain</code>命令来查看具体使用的执行计划</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code> <span class="token keyword">explain</span> <span class="token keyword">select</span> user_id<span class="token punctuation">,</span>name <span class="token keyword">from</span> t_user <span class="token keyword">where</span> user_id <span class="token operator">&gt;</span> <span class="token number">10</span>  <span class="token operator">and</span> name <span class="token operator">like</span> <span class="token string">&#39;用户1%&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>mysql<span class="token operator">&gt;</span>   explain <span class="token keyword">select</span> user_id,name from t_user where user_id <span class="token operator">&gt;</span> <span class="token number">10</span>  and name like <span class="token string">&#39;用户1%&#39;</span><span class="token punctuation">;</span>
+----+-------------+--------+------------+-------+--------------------+------------+---------+------+------+----------+--------------------------+
<span class="token operator">|</span> <span class="token function">id</span> <span class="token operator">|</span> select_type <span class="token operator">|</span> table  <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token builtin class-name">type</span>  <span class="token operator">|</span> possible_keys      <span class="token operator">|</span> key        <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> rows <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra                    <span class="token operator">|</span>
+----+-------------+--------+------------+-------+--------------------+------------+---------+------+------+----------+--------------------------+
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> SIMPLE      <span class="token operator">|</span> t_user <span class="token operator">|</span> NULL       <span class="token operator">|</span> range <span class="token operator">|</span> PRIMARY,index_name <span class="token operator">|</span> index_name <span class="token operator">|</span> <span class="token number">86</span>      <span class="token operator">|</span> NULL <span class="token operator">|</span>  <span class="token number">112</span> <span class="token operator">|</span>    <span class="token number">99.00</span> <span class="token operator">|</span> Using where<span class="token punctuation">;</span> Using index <span class="token operator">|</span>
+----+-------------+--------+------------+-------+--------------------+------------+---------+------+------+----------+--------------------------+
<span class="token number">1</span> row <span class="token keyword">in</span> set, <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>possible_keys</code> 表示可能使用的索引 本例中是（PRIMARY,index_name ）两个索引都可以。</li><li><code>key</code> 表示实际使用的索引 本例中是 （index_name）</li><li><code>key_len</code> 表示索引中使用的字节数，可通过该列计算查询中使用的索引的长度。</li></ul><div class="custom-container tip"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="9"></circle><path d="M12 8h.01"></path><path d="M11 12h1v4h1"></path></g></svg><p class="custom-container-title">TIP</p><p>优化器为什么使用name索引而不使用主键索引？</p></div><p>因为name索引的叶子节点存储的是主键user_id, 而要查询的字段 (user_id,name) 需要的数据name索引中都能够直接提供， 同时name索引由于叶子节点存储的主键，而主键索引叶子节点存储的是完整的行数据。 扫描name索引要比扫描主键索引的成本小很多，优化器基于查询成本考虑决定使用name索引。</p><p>这其实就是常说的覆盖索引，在满足业务的前提下尽可能的减少查询的字段，这样才能让MySQL使用覆盖索引来优化。</p><h3 id="第四步-执行器" tabindex="-1"><a class="header-anchor" href="#第四步-执行器" aria-hidden="true">#</a> 第四步 执行器</h3><p>MySQL通过分析器知道了你要做什么，通过优化器知道了该怎么做，于是就进入了执行器阶段，开始执行语句。</p><p>执行器和存储引擎的交互是以行为单位的。 我们以以下的SQL为例，他的执行过程大致如下：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t_user <span class="token keyword">where</span> age<span class="token operator">&gt;</span><span class="token number">20</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol><li>执行器在一个while循环中调用 存储引擎获取第一行数据，判断age是否大于20，如果符合则将行数据加入到结果集中</li><li>调用引擎接口取下一行，重复相同的判断逻辑，直到取到这个表的最后一行。</li><li>执行器将上述遍历过程中所有满足条件的行组成的记录集作为结果集返回给客户端。</li></ol><p>至此，整个查询的过程就完成了。</p><p>对于用到索引的查询，过程也是类似的，区别在于存储引擎可以利用索引的B+树结构快速的查找数据。 对于主键的等值查询，因为符合条件的数据最多只有一行，所以获取下一行的函数会直接返回。</p><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><p>执行一条 查询SQL语句，期间发生了什么？</p><ul><li>连接器：建立连接，管理连接、校验用户身份；</li><li>查询缓存：查询语句如果命中查询缓存则直接返回，否则继续往下执行。MySQL 8.0 已删除该模块；</li><li>分析器：通过解析器对 SQL 查询语句进行词法分析、语法分析，然后构建语法树，方便后续模块读取表名、字段、语句类型；</li><li>优化器：基于查询成本的考虑， 选择查询成本最小的执行计划；</li><li>执行器：根据执行计划执行 SQL 查询语句，从存储引擎读取记录，返回给客户端；</li></ul></div></div><footer class="page-meta"><!----><!----></footer><!----><div class="reco-valine-wrapper" style="display:block;"><div id="valine"></div></div></main><!--]--><div class="page-catalog-container"><h5 class="tip"> </h5><ul><!--[--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blogs/mysql/how_select.html#mysql的逻辑架构" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="MySQL的逻辑架构"><!--[--><!--]--><!--v-if--><span>MySQL的逻辑架构</span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blogs/mysql/how_select.html#第一步-连接器" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="第一步 连接器"><!--[--><!--]--><!--v-if--><span>第一步 连接器</span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blogs/mysql/how_select.html#第二步-查询缓存" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="第二步 查询缓存"><!--[--><!--]--><!--v-if--><span>第二步 查询缓存</span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blogs/mysql/how_select.html#第三步-分析器" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="第三步 分析器"><!--[--><!--]--><!--v-if--><span>第三步 分析器</span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blogs/mysql/how_select.html#第四步-优化器" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="第四步 优化器"><!--[--><!--]--><!--v-if--><span>第四步 优化器</span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blogs/mysql/how_select.html#第四步-执行器" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="第四步 执行器"><!--[--><!--]--><!--v-if--><span>第四步 执行器</span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blogs/mysql/how_select.html#总结" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="总结"><!--[--><!--]--><!--v-if--><span>总结</span><!--[--><!--]--></a></li><!--]--><!--]--></ul></div></div></div></div><!----><!----><!--]--></div>
    <script type="module" src="/assets/app-9816ed7f.js" defer></script>
  </body>
</html>
